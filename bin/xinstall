#!/usr/bin/env sh
CMD_BASE="$(readlink -f $0)" || CMD_BASE="$0"; CMD_BASE="$(dirname $CMD_BASE)"

_INCLUDES=minimal
for item in $_INCLUDES; do . "$CMD_BASE/../lib/$item.sh"; done

import_shell_lib || FORCE=1 install_shell_lib

_PLUGINS=''
# breaks if "plugins" dir contains only non *.sh files
test -d "$CMD_BASE"/../plugins && test "$(ls "$CMD_BASE"/../plugins)" && \
  for item in "$CMD_BASE"/../plugins/*.sh; do
    . $item && \
    _pn="$(basename "$item")" && \
    _PLUGINS="$_PLUGINS ${_pn%.sh}"
  done

test "$DEBUG" && set -x

main() {
  call_fun "$@"
}

invalid_cmd() {
  echo "Usage: $0 update-pkg-list|install-base|install-pkg|install|save-image-info|configure|add-user|cleanup"
  echo "Input params: " "$@"
  return 1
}

call_fun() {
  local fun="$1"; test $# -gt 0 && shift
  local item="$1"; test $# -gt 0 && shift

  local distro
  hascmd apt-get && distro=debian
  hascmd apk && distro=alpine

  local fname="$(echo ${fun}${item:+_$item})"; fname="$(echo $fname | tr -c 'a-zA-Z0-9_\n' '_' )"
  for fn in "$fname" "${distro:+${fname}_$distro}"; do
    test "$fn" || continue
    hascmd "$fn" && { eval "$fn" "$@"; return ;}
  done

  invalid_cmd "$fun $item" "$@"

}

add_user() {

  hascmd apk && \
    { add_user_alpine "$@"; return ;}

  hascmd apt-get && \
    { add_user_debian "$@"; return ;}

  os_version && return 1

}

add_user_alpine() {
  local user="$1"; shift

  adduser -D -h "$HOME" -s /bin/bash "$user" || return
  # Disable sudo: echo 'auth requisite  pam_deny.so' > /etc/pam.d/su
  { getent group "sudo" || addgroup -S sudo ;} || return
  printf '%sudo   ALL=(ALL:ALL) ALL\n' >> /etc/sudoers || return
  gpasswd -a "$user" sudo || return
  printf "$user ALL=(ALL) NOPASSWD: ALL\n" >> /etc/sudoers || return

  mkdir -p "$HOME"/.ssh && \
  chmod go-w "$HOME" && \
  chmod 700 "$HOME"/.ssh && \
  chown -R "$user:$user" "$HOME"
}

add_user_debian() {
  local user="$1"; shift

  adduser --disabled-password --home "$HOME" --shell /bin/bash --gecos "" "$user" || return
  gpasswd -a "$user" sudo || return $?
  printf "$user ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers || return
  mkdir -p $HOME/.ssh && \
  chmod go-w $HOME && \
  chmod 700 $HOME/.ssh && \
  chown -R "$user:$user" "$HOME"
}

cleanup() {

  if hascmd apk ; then
    cleanup_alpine "$@" || return
  elif hascmd apt-get ; then
    cleanup_debian "$@" || return
  fi

  local rm_items='/tmp/* /var/tmp/* /var/backups/* /usr/share/man /usr/share/doc'
  echo Removing $rm_items
  rm -rf $rm_items

}

cleanup_alpine() {
  rm -rf /var/cache/apk/*
}

cleanup_debian() {
  #ENV RM_APT='/var/lib/apt/lists/* /var/lib/apt /var/lib/dpkg'
  apt-get autoremove --purge -y && apt-get clean && \
  rm -rf /etc/cron.daily/{apt,passwd}
}

main "$@"
