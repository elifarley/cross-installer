#!/usr/bin/env sh
CMD_BASE="$(readlink -f $0)" || CMD_BASE="$0"; CMD_BASE="$(dirname $CMD_BASE)"

_INCLUDES=os
for item in $_INCLUDES; do . "$CMD_BASE/../lib/$item.sh"; done

_PLUGINS=''
# breaks if "plugins" dir contains only non *.sh files
test -d "$CMD_BASE"/../plugins && test "$(ls "$CMD_BASE"/../plugins)" && \
  for item in "$CMD_BASE"/../plugins/*.sh; do
    . $item && \
    _pn="$(basename "$item")" && \
    _PLUGINS="$_PLUGINS ${_pn%.sh}"
  done

test "$DEBUG" && set -x
export IMAGE_INFO_FILE="$HOME"/docker-image.info

main() {
  local cmd="$1"; shift
  case "$cmd" in
    update-pkg-list)
      update_pkg_list "$@"
      ;;
    install-pkg)
      install_pkg "$@"
      ;;
    install)
      install "$@"
      ;;
    install-base)
      install_base "$@"
      ;;
    save-image-info)
      save_image_info "$@"
      ;;
    configure)
      configure "$@"
      ;;
    add-user)
      add_user "$@"
      ;;
    cleanup)
      cleanup "$@"
      ;;
    *)
      invalid_cmd "$cmd" "$@"
  esac
}

invalid_cmd() {
  echo "Usage: $0 update-pkg-list|install-base|install-pkg|install|save-image-info|configure|add-user|cleanup"
  echo "Input params: " "$@"
  return 1
}

save_image_info() {
  local first_time=''
  test -f "$IMAGE_INFO_FILE" && printf -- '---\n\n' >> "$IMAGE_INFO_FILE" || first_time=1
  printf 'Build date: %s %s\n' "$(date +'%F %T.%N')" "$(date +%Z)" >> "$IMAGE_INFO_FILE"
  printf "Base image: $BASE_IMAGE\n" >> "$IMAGE_INFO_FILE"
  test "$first_time" && printf '%s\n(%s)\n' "$(os_version)" "$(uname -rsv)" >> "$IMAGE_INFO_FILE"
  return 0
}

update_pkg_list() {

  which apk && {
    update_pkg_list_alpine "$@" && return || return $?
  }

  which apt-get && {
    update_pkg_list_debian "$@" && return || return $?
  }

  os_version && return 1

}

update_pkg_list_alpine() {
  apk update
}

update_pkg_list_debian() {
  local aptconfig=/etc/apt/apt.conf.d/local
  test -f "$aptconfig" && grep 'Install-Recommends' "$aptconfig" && return 0

  printf 'APT::Get::Install-Recommends "false";\nDpkg::Options {\n"--force-confdef";\n"--force-confold";\n}' \
> "$aptconfig" && apt-get update && apt-get -y dist-upgrade
}

install() {
  local arg="$1"; shift
  case "$arg" in
    timezone)
      install_timezone "$@"
      ;;
    tini)
      install_tini "$@"
      ;;
    gosu)
      install_gosu "$@"
      ;;
    *)
      call_plugin_fun install "$arg" "$@"
  esac
}

call_plugin_fun() {
  local fun="$1"; shift
  local item="$1"; shift
  local fname

  for p in $_PLUGINS; do
    fname="${p}_${fun}_${item}"
    type "$fname" | head -n1 | grep -q function || continue
    eval "$fname" "$@" && return 0 || return $?
  done

  invalid_cmd "$arg" "$@"

}

install_base() {
  curl -fsSL https://raw.githubusercontent.com/elifarley/docker-dev-env/master/entry.sh -o /entry.sh || return $?
  curl -fsSL https://raw.githubusercontent.com/elifarley/docker-dev-env/master/env-vars.sh -o /env-vars.sh || return $?
  chmod +x /*.sh || return $?
}

install_tini() {
  test $# = 2 || {
    echo "Usage: $0 install tini <version> <sha1>"
    return 1
  }
  local version="$1"; shift
  local sha="$1"; shift
  curl -fsSL https://github.com/krallin/tini/releases/download/"$version"/tini-static -o /bin/tini && \
chmod +x /bin/tini && echo "$sha  /bin/tini" | sha1sum -wc -
}

install_gosu() {
  test $# = 2 || {
    echo "Usage: $0 install tini <version> <sha1>"
    return 1
  }
  local version="$1"; shift
  local sha="$1"; shift
  curl -fsSL https://github.com/tianon/gosu/releases/download/"$version"/gosu-amd64 -o /bin/gosu && \
    chmod 755 /bin/gosu && echo "$sha  /bin/gosu" | sha1sum -wc -
}

install_timezone() {

  test "$TZ" || {
    echo "TZ is not set"
    return 1
  }

  which apk && {
    install_timezone_alpine "$@" && return || return $?
  }

  which apt-get && {
    install_timezone_debian "$@" && return || return $?
  }

  os_version && return 1

}

install_timezone_alpine() {
  apk add --no-cache tzdata || return $?
  echo "TZ set to '$TZ'"
  echo $TZ > /etc/TZ
  cp -a /usr/share/zoneinfo/"$TZ" /etc/localtime || return $?
  apk del tzdata
}

install_timezone_debian() {
  # locale-gen $LANG && dpkg-reconfigure locales && /usr/sbin/update-locale LANG=$LANG
  echo "TZ set to '$TZ'"
  echo $TZ > /etc/TZ
  rm -f /etc/localtime && ln -s /usr/share/zoneinfo/"$TZ" /etc/localtime
}

install_pkg() {

  which apk && {
    install_pkg_alpine "$@" && return || return $?
  }

  which apt-get && {
    install_pkg_debian "$@" && return || return $? 
  }

  os_version && return 1

}

install_pkg_alpine() {
  grep -q 'testing' /etc/apk/repositories || \
    echo http://nl.alpinelinux.org/alpine/edge/testing >> /etc/apk/repositories
  test $# = 0 && apk add --no-cache $APK_PACKAGES || apk add --no-cache "$@"
}

install_pkg_debian() {
  test $# = 0 && \
    apt-get install -y --no-install-recommends $APTGET_PACKAGES \
    || apt-get install -y --no-install-recommends "$@"
}
  
configure() {
  local arg="$1"; shift
  case "$arg" in
    sshd)
      configure_sshd "$@"
      ;;
    *)
      invalid_cmd "$arg" "$@"
  esac
}

configure_sshd() {

  which apk && {
    configure_sshd_alpine "$@" && return || return $?
  }

  which apt-get && {
    configure_sshd_debian "$@" && return || return $? 
  }

  os_version && return 1

}

configure_sshd_alpine() {
  sed -e '/Port/d;/UsePrivilegeSeparation/d;/PermitRootLogin/d;/PermitUserEnvironment/d;/UsePAM/d;/UseDNS/d;/PasswordAuthentication/d;/ChallengeResponseAuthentication/d;/Banner/d;/PrintMotd/d;/PrintLastLog/d' \
    /etc/ssh/sshd_config > /etc/ssh/sshd_config.tmp || return $?
  printf "\nPort 2200\nUsePrivilegeSeparation no\nPermitRootLogin no\nPasswordAuthentication no\nChallengeResponseAuthentication no\nPermitUserEnvironment yes\nUseDNS no\nPrintMotd no\n\n#---\n" \
    > /etc/ssh/sshd_config || return $?
  cat /etc/ssh/sshd_config.tmp >> /etc/ssh/sshd_config || return $?
  rm /etc/ssh/sshd_config.tmp || return $?
  cp -a /etc/ssh /etc/ssh.cache
}

configure_sshd_debian() {
  sed -e '/Port/d;/UsePrivilegeSeparation/d;/PermitRootLogin/d;/PermitUserEnvironment/d;/UsePAM/d;/PasswordAuthentication/d;/ChallengeResponseAuthentication/d;/Banner/d' /etc/ssh/sshd_config > /etc/ssh/sshd_config.tmp || return $?
  printf "\nPort 2200\nUsePrivilegeSeparation no\nPermitRootLogin no\nUsePAM no\nPasswordAuthentication no\nChallengeResponseAuthentication no\nPermitUserEnvironment yes\n\n#---\n" > /etc/ssh/sshd_config || return $?
  cat /etc/ssh/sshd_config.tmp >> /etc/ssh/sshd_config && rm /etc/ssh/sshd_config.tmp && \
  cp -a /etc/ssh /etc/ssh.cache
}

add_user() {

  which apk && \
    { add_user_alpine "$@" && return || return $? ;}

  which apt-get && \
    { add_user_debian "$@" && return || return $? ;}

  os_version && return 1

}

add_user_alpine() {
  local user="$1"; shift

  adduser -D -h "$HOME" -s /bin/bash "$user" || return $?
  # Disable sudo: echo 'auth requisite  pam_deny.so' > /etc/pam.d/su
  { getent group "sudo" || addgroup -S sudo ;} || return $?
  printf '%sudo   ALL=(ALL:ALL) ALL\n' >> /etc/sudoers || return $?
  gpasswd -a "$user" sudo || return $?
  printf "$user ALL=(ALL) NOPASSWD: ALL\n" >> /etc/sudoers || return $?
  mkdir -p "$HOME"/.ssh || return $?
  chmod go-w "$HOME" || return $?
  chmod 700 "$HOME"/.ssh

  chown -R "$user:$user" "$HOME"
}

add_user_debian() {
  local user="$1"; shift

  adduser --disabled-password --home "$HOME" --shell /bin/bash --gecos "" "$user" || return $?
  gpasswd -a "$user" sudo || return $?
  printf "$user ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers || return $?
  mkdir -p $HOME/.ssh || return $?
  chmod go-w $HOME || return $?
  chmod 700 $HOME/.ssh
}

cleanup() {

  which apk && {
    cleanup_alpine "$@" || return $?

  } || which apt-get && {
    cleanup_debian "$@" || return $?

  }

  local rm_items='/tmp/* /var/tmp/* /var/backups/* /usr/share/man /usr/share/doc'
  echo Removing $rm_items
  rm -rf $rm_items || return $?

}

cleanup_alpine() {
  rm -rf /var/cache/apk/*
}

cleanup_debian() {
  #ENV RM_APT='/var/lib/apt/lists/* /var/lib/apt /var/lib/dpkg'
  apt-get autoremove --purge -y && apt-get clean && \
  rm -rf /etc/cron.daily/{apt,passwd}
}

main "$@"
